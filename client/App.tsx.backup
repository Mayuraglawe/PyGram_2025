import "./global.css";

import { Toaster } from "@/components/ui/toaster";
import { createRoot } from "react-dom/client";
import { Toaster as Sonner } from "@/components/ui/sonner";
import { TooltipProvider } from "@/components/ui/tooltip";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import { Provider } from "react-redux";
import { store } from "@/store/store";
import { AuthProvider, ProtectedRoute } from "./contexts/AuthContext";
import { DepartmentProvider } from "./contexts/DepartmentContext";
import { DepartmentRouter } from "./components/routing/DepartmentRouter";
import { NotificationProvider } from "./contexts/NotificationContext";
import AppLayout from "@/components/layout/AppLayout";
import Index from "./pages/Index";
import NotFound from "./pages/NotFound";
import LandingPage from "./pages/LandingPage";
import FacultyPage from "./pages/Faculty";
import SubjectsPage from "./pages/Subjects";
import ClassroomsPage from "./pages/Classrooms";
import BatchesPage from "./pages/Batches";
import TimetablesPage from "./pages/Timetables";
import GeneratePage from "./pages/Generate";
import SignInPage from "./pages/SignIn";
import RegisterPage from "./pages/Register";
import RoleSelectionPage from "./pages/RoleSelection";
import DepartmentsPage from "./pages/Departments";
import Events from './pages/Events';
import ConflictResolution from './pages/ConflictResolution';
import AdminPage from './pages/Admin';
import TelegramSetup from './pages/TelegramSetup';
import CreateTimetable from './pages/CreateTimetable';
import TimetableEdit from './pages/TimetableEdit';
import HODReview from './pages/HODReview';
import AITimetableCreator from './pages/AITimetableCreator';
import { NotificationList } from './components/notifications/NotificationComponents';

const queryClient = new QueryClient();

const App = () => (
  <Provider store={store}>
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <AuthProvider>
          <DepartmentProvider>
            <NotificationProvider>
              <Toaster />
              <Sonner />
              <BrowserRouter>
                <Routes>
                  {/* Public routes - completely outside any wrapper */}
                  <Route path="/" element={<LandingPage />} />
                  <Route path="/signin" element={<SignInPage />} />
                  <Route path="/register" element={<RegisterPage />} />
                  <Route path="/role-selection" element={<RoleSelectionPage />} />
                  
                  {/* All protected routes */}
                  <Route path="/dashboard" element={
                    <DepartmentRouter>
                      <ProtectedRoute>
                        <AppLayout>
                          <Index />
                        </AppLayout>
                      </ProtectedRoute>
                    </DepartmentRouter>
                  } />
                  
                  {/* Faculty management - Admin and Mentors only */}
                  <Route path="/faculty" element={
                    <DepartmentRouter>
                      <ProtectedRoute requiredPermission="view_department_data">
                        <AppLayout>
                          <FacultyPage />
                        </AppLayout>
                      </ProtectedRoute>
                    </DepartmentRouter>
                  } />
                  
                  {/* Subjects management - Admin and Mentors only */}
                  <Route path="/subjects" element={
                    <DepartmentRouter>
                <ProtectedRoute requiredPermission="view_department_data">
                  <AppLayout>
                    <FacultyPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Subjects management - Admin and Mentors only */}
              <Route path="/subjects" element={
                <ProtectedRoute requiredPermission="view_department_data">
                  <AppLayout>
                    <SubjectsPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Classrooms management - Admin and Mentors only */}
              <Route path="/classrooms" element={
                <ProtectedRoute requiredPermission="view_department_data">
                  <AppLayout>
                    <ClassroomsPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Batches management - Admin and Mentors only */}
              <Route path="/batches" element={
                <ProtectedRoute requiredPermission="view_department_data">
                  <AppLayout>
                    <BatchesPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Timetables - All authenticated users can view */}
              <Route path="/timetables" element={
                <ProtectedRoute requiredPermission="view_timetables">
                  <AppLayout>
                    <TimetablesPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Generate timetables - Admin only */}
              <Route path="/generate" element={
                <ProtectedRoute requiredRole="admin">
                  <AppLayout>
                    <GeneratePage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Create timetables - Now uses AI Creator (Creator Mentors only) */}
              <Route path="/timetables/create" element={
                <ProtectedRoute requiredPermission="create_timetable_drafts">
                  <AppLayout>
                    <AITimetableCreator />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* AI Timetable Creator - Alternate route */}
              <Route path="/timetables/ai-create" element={
                <ProtectedRoute requiredPermission="create_timetable_drafts">
                  <AppLayout>
                    <AITimetableCreator />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Edit timetables - Creator and Publisher Mentors */}
              <Route path="/timetables/:id/edit" element={
                <ProtectedRoute requiredPermission="edit_timetables">
                  <AppLayout>
                    <TimetableEdit />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Publisher Review Queue - Publisher Mentors only */}
              <Route path="/timetables/review" element={
                <ProtectedRoute requiredPermission="publish_timetables">
                  <AppLayout>
                    <HODReview />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Department management - Admin only */}
              <Route path="/departments" element={
                <ProtectedRoute requiredRole="admin">
                  <AppLayout>
                    <DepartmentsPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Admin panel - Admin only */}
              <Route path="/admin" element={
                <ProtectedRoute requiredRole="admin">
                  <AppLayout>
                    <AdminPage />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Telegram Setup - Admin only */}
              <Route path="/telegram-setup" element={
                <ProtectedRoute requiredRole="admin">
                  <AppLayout>
                    <TelegramSetup />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Event management - All authenticated users can view, mentors can create */}
              <Route path="/events" element={
                <ProtectedRoute requiredPermission="view_public_events">
                  <AppLayout>
                    <Events />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Conflict Resolution - Admins and Mentors can view event queue */}
              <Route path="/conflict-resolution" element={
                <ProtectedRoute requiredPermission="view_event_queue">
                  <AppLayout>
                    <ConflictResolution />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
              {/* Notifications - All authenticated users */}
              <Route path="/notifications" element={
                <ProtectedRoute>
                  <AppLayout>
                    <NotificationList />
                  </AppLayout>
                </ProtectedRoute>
              } />
              
                  </Routes>
                </DepartmentRouter>
              } />
              
              {/* Catch-all route for unmatched paths */}
              <Route path="*" element={<NotFound />} />
            </Routes>
          </BrowserRouter>
        </NotificationProvider>
      </DepartmentProvider>
    </AuthProvider>
    </TooltipProvider>
  </QueryClientProvider>
</Provider>
);

createRoot(document.getElementById("root")!).render(<App />);
